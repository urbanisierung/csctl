{
  "mode": "plan",
  "completedPhases": [
    "plan-clarify-0",
    "plan-review-1"
  ],
  "spec": "Here is the complete revised section:\n\n---\n\n## Problem Statement\n\nThe existing `csctl` bash CLI for installing Camunda 8 on kind is outdated. Camunda now maintains an official `camunda-deployment-references` repo with well-structured scripts for local kind deployment. Replace `csctl` with a new version that wraps those official scripts, providing a one-shot install experience with a clean spinner UI.\n\n## Acceptance Criteria\n\n### 1. Repository Management\n- On first run, `csctl` clones `camunda/camunda-deployment-references` (branch `stable/<version>`) into `~/.config/csctl/camunda-deployment-references/`\n- On subsequent runs, it pulls latest changes (or re-clones if version changed)\n- Default version: `8.8`, configurable via `--version <version>` flag\n- Stores state (mode, version, chart version) in `~/.config/csctl/state` file\n\n### 2. Environment Variables\nBefore invoking any reference repo script, `csctl` must export the following environment variables (matching the Makefile defaults):\n- `CLUSTER_NAME=camunda-platform-local`\n- `CAMUNDA_NAMESPACE=camunda`\n- `CAMUNDA_RELEASE_NAME=camunda`\n- `CERT_DIR=.certs`\n\nThese are required by every `procedure/` script in the reference repo. Without them, script calls will fail.\n\n### 3. Install Command (`csctl` or `csctl install`)\n- **Domain mode (default):** Executes these steps in sequence:\n  1. `procedure/cluster-create.sh`\n  2. `procedure/ingress-nginx-deploy.sh`\n  3. `procedure/coredns-config.sh`\n  4. `procedure/hosts-add.sh` (requires sudo)\n  5. `procedure/certs-generate.sh`\n  6. `procedure/certs-create-secret.sh`\n  7. `procedure/certs-create-ca-configmap.sh`\n  8. Helm install (see §5 for full invocation) with `values-domain.yml` + `values-mkcert.yml` + any extra values\n  9. Wait for pods ready via `../../../generic/kubernetes/single-region/procedure/check-deployment-ready.sh` (relative to `kind-single-region/`)\n- **No-domain mode (`--no-domain`):** Executes:\n  1. `procedure/cluster-create.sh`\n  2. Add keycloak hosts entry: csctl implements this inline — if `/etc/hosts` does not already contain `camunda-keycloak`, append `127.0.0.1  camunda-keycloak` (requires sudo). There is no script for this in the reference repo; the Makefile does it inline via `grep`/`tee`.\n  3. Helm install (see §5) with `values-no-domain.yml` + any extra values\n  4. Wait for pods ready via `../../../generic/kubernetes/single-region/procedure/check-deployment-ready.sh`\n- At the end, prints credentials and access URLs (see §8)\n- Saves mode (`domain`/`no-domain`) to state file\n\n### 4. Extra Values / Profiles\n- `-f <file>` flag: appends additional `--values <file>` to the `helm upgrade --install` call (can be specified multiple times)\n- `-p <profile>` flag: uses a profile YAML from `csctl` repo's `extra-values/` directory (appended as extra `--values`)\n- Does NOT modify the cloned reference repo; csctl calls `helm` directly (replicating what the deploy scripts do) and appends extra values files\n\n### 5. Helm Install Invocation\nSince csctl calls `helm` directly (not the deploy scripts), the full invocation must be specified:\n```\nhelm upgrade --install camunda camunda-platform \\\n  --repo https://helm.camunda.io \\\n  --namespace camunda --create-namespace \\\n  --version <CAMUNDA_HELM_CHART_VERSION> \\\n  --values <mode-specific values files> \\\n  --values <extra values files...>\n```\n- **Release name:** `camunda`\n- **Chart name:** `camunda-platform`\n- **Repo URL:** `https://helm.camunda.io`\n- **Namespace:** `camunda` (matching `CAMUNDA_NAMESPACE`)\n- **Chart version:** Parsed from the reference repo's `procedure/camunda-deploy-domain.sh` (or `camunda-deploy-no-domain.sh`), which sets `CAMUNDA_HELM_CHART_VERSION` (e.g., `13.4.2`). csctl extracts this value at runtime. Optionally overridable via `--chart-version <version>` flag.\n- **Values files (domain mode):** `values-domain.yml`, `values-mkcert.yml`, plus any `-f` / `-p` extras\n- **Values files (no-domain mode):** `values-no-domain.yml`, plus any `-f` / `-p` extras\n\n### 6. Sub-commands\n- `csctl credentials` — prints default username (`admin`) and password (from `procedure/get-password.sh`). If no install has been performed (no state file or no cluster), prints a clear error message.\n- `csctl delete` — reads saved mode from state, then:\n  1. `helm uninstall camunda --namespace camunda`\n  2. `kind delete cluster --name camunda-platform-local`\n  3. If domain mode: remove hosts entries (reverse of `hosts-add.sh`), clean generated certs\n  4. If no-domain mode: remove `camunda-keycloak` entry from `/etc/hosts`\n  5. If no state file exists: prompt user to specify mode, or check if cluster exists and infer\n- `csctl port-forward` — runs `procedure/port-forward.sh` from the reference repo. Intended for no-domain mode. If the state file indicates domain mode, print a warning (`Port forwarding is intended for no-domain mode. In domain mode, access services via https://camunda.example.com.`) but still execute if the user proceeds.\n\n### 7. Output UX\n- **Default:** Suppress individual script output; show a spinner with current step name (e.g., `⠋ Creating Kind cluster...`). On step completion, show `✓ Step name` and move to next.\n- **`-v` / `--verbose`:** Show full output from each script as it runs\n- On error, always show the failed step's output regardless of verbose mode\n\n### 8. Post-Install Output\nAfter successful install, print credentials and access information. Output differs by mode:\n- **Domain mode:** Print:\n  - Username: `admin`\n  - Password: (from `procedure/get-password.sh`)\n  - Access URL: `https://camunda.example.com`\n- **No-domain mode:** Print:\n  - Username: `admin`\n  - Password: (from `procedure/get-password.sh`)\n  - Instruction: `Run 'csctl port-forward' to access services, then open:`\n  - List localhost ports (as documented in reference repo, e.g., `http://localhost:8080` for Operate, etc.)\n\n### 9. Prerequisites Check\n- Check for: `docker`, `kind`, `kubectl`, `helm`, `git`\n- Domain mode additionally checks for: `mkcert`\n- `csctl` does NOT depend on `make`. Although the reference repo documents `make` targets as its primary interface, csctl invokes the `procedure/` scripts directly.\n- Print clear error messages for missing tools\n\n## Technical Requirements\n- Pure bash (no external dependencies beyond the prerequisites)\n- Replace `scripts/csctl` with the new implementation\n- Update `README.md` to reflect new usage\n- Keep `extra-values/` directory for profiles\n- Working directory for reference repo scripts: `~/.config/csctl/camunda-deployment-references/local/kubernetes/kind-single-region/`\n- The `scripts/install` script can remain (it downloads csctl to the user's PATH)\n- The path to `check-deployment-ready.sh` is `../../../generic/kubernetes/single-region/procedure/check-deployment-ready.sh` relative to `kind-single-region/`, not in the `procedure/` directory alongside other scripts\n\n## Edge Cases\n- Cluster already exists → handled by kind (idempotent via `kind create cluster`)\n- Hosts entries already present → reference scripts already handle this (grep before adding); csctl's inline keycloak hosts logic must also grep before adding\n- Re-running install when already installed → `helm upgrade --install` is idempotent\n- Running `csctl delete` with no state file → prompt user to specify mode or check if cluster exists\n- Running `csctl credentials` before install → clear error message\n- Extra values file doesn't exist → error before starting install\n- `csctl port-forward` in domain mode → print warning but allow execution\n\n## Out of Scope\n- Enterprise registry credentials (removed; the reference repo doesn't use them)\n- Unreleased helm charts support (`-u` flag from old csctl)\n- Console-specific TLS certificate generation\n- Custom cluster names / namespaces (use reference repo defaults: `camunda-platform-local` / `camunda`)\n- Windows support\n- Invoking `make` (csctl calls scripts directly)",
  "engDecisions": "",
  "designDecisions": "",
  "analysis": "",
  "issueBody": "The repo is used as an easiert way to install Camunda C8 locally with kind. In the meanwhile, there are new docs available, that already describe very good\nwhat needs to be done for the installation. Study and research the docs: https://docs.camunda.io/docs/self-managed/deployment/helm/cloud-providers/kind/\nThere are also references to many scripts that need to be executed in sequence. My goal is to get a one shot command to install everything.\nThe approach should be:\n1. git clone the camunda-deployment-references repo (or update if already available) - use the csctl folder in ~/.config\n2. execute one script, that executes all the listed scripts (default: domain mode, but there should be a way for a no-domain mode)\n3. A sub command that prints credentials: https://docs.camunda.io/docs/self-managed/deployment/helm/cloud-providers/kind/#default-credentials\n4. A sub command that deletes everything: https://docs.camunda.io/docs/self-managed/deployment/helm/cloud-providers/kind/#cleanup\n\nIt would be great if the default print out would overwrite the individual outputs, and only prints out the current step with a spinner.\nWith a parameter -v / --verbose the individual output can be enabled.\n\nUse the same tech stack as available: bash. Also make sure to support overrides via custom extra values yaml files.",
  "runId": "2026-02-17T09-35-36-005Z",
  "tasks": [],
  "designSpec": "",
  "streamResults": [],
  "answeredQuestions": {
    "plan-clarify-0": [
      {
        "question": "I have a good understanding of the request. A few clarifying questions before I finalize requirements:\n\n1. **Replace or coexist?** Should this completely replace the existing `csctl` script, or should it be a new version alongside it? The existing script has its own approach (profiles like xs/sm/md/lg, custom helm template flow, self-signed openssl certs). The new approach would delegate entirely to the `camunda-deployment-references` scripts (mkcert, Makefile-style steps).\n\n2. **Branch/version configurability?** The reference repo uses `stable/8.8`. Should this be configurable via a flag (e.g., `--version 8.7`) so users can target different Camunda versions, or is `8.8` hardcoded for now?\n\n3. **Extra values override mechanism?** For custom extra values YAML files, should `csctl` accept one or more `-f <file>` flags that get appended as additional `--values` to the underlying `helm upgrade --install` command? This would mean modifying the deploy scripts from the reference repo. Should csctl patch/wrap those scripts, or do you want it to call `helm` directly instead of delegating to the reference scripts?\n\n4. **Mode memory for cleanup?** Should csctl remember which mode (domain/no-domain) was used for installation, so `csctl delete` automatically does the right cleanup? Or should the user specify `csctl delete --no-domain`?\n\n5. **Port-forwarding for no-domain?** After a no-domain install completes, should csctl automatically start port-forwarding, or just tell the user how to start it (e.g., `csctl port-forward`)?",
        "answer": "1. replace\n2. make it configurable, default to 8.8\n3. I'd like to keep a similar approach with the profiles.\nFind a way to not modify the repo, but somehow inject the custom values.\n4. remember mode\n5. add a sub command for the port forwarding and print it out"
      }
    ],
    "plan-eng-clarify-2": [
      {
        "question": "I've thoroughly reviewed the codebase and the reference repo. Two questions:\n\n1. **`jq` as prerequisite**: The `check-deployment-ready.sh` script from the reference repo uses `jq` (`kubectl get pods ... -o json | jq -r '...'`). Should I add `jq` to the prerequisites check alongside `docker`, `kind`, `kubectl`, `helm`, and `git`?\n\n2. **Existing `extra-values/` profiles**: The current profile YAMLs (e.g., `xs.yaml`, `lg.yaml`) use shell variable placeholders like `${HOST}` and `${CONSOLE_VERSION}` and reference the old helm chart structure (e.g., `camunda-platform` TLS secret name, `camunda.local` host pattern). These won't work when passed as `--values` to the new reference repo's helm install (which uses `camunda.example.com`, different secret names, etc.). Should I:\n   - (a) Update/replace the profiles to be compatible with the reference repo's values structure, or\n   - (b) Leave them as-is (users create their own compatible profiles), or\n   - (c) Remove them and provide a few simple example profiles that match the reference repo?",
        "answer": "1. yes\n2. c, but only generate examples with console"
      }
    ]
  },
  "sessionLog": {
    "plan-clarify-0": {
      "sessionId": "71c1aab4-b256-4230-9374-278c8bdaa29b",
      "agent": "planner",
      "role": "pm"
    },
    "plan-review-1/reviewer-1": {
      "sessionId": "d10f15f3-6aae-4199-83ed-c3afb065397c",
      "agent": "inline-agent",
      "role": "inline-agent"
    },
    "plan-review-1/revision-1": {
      "sessionId": "6c60f5c1-fcc0-455a-88c7-ea2394e1e6ca",
      "agent": "inline-agent",
      "role": "inline-agent"
    },
    "plan-review-1/reviewer-2": {
      "sessionId": "b886c8bf-a464-4057-b343-55e07ce89ecf",
      "agent": "inline-agent",
      "role": "inline-agent"
    },
    "plan-eng-clarify-2": {
      "sessionId": "00468358-271c-4e46-99f3-c28eeca30699",
      "agent": "plan-eng-clarify-2",
      "role": "plan-eng-clarify-2"
    }
  }
}